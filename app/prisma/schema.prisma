// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Optional: Uncomment and set for connection pooling
}

model Company {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  website          String?   @unique
  domain           String?   @unique
  linkedinUrl      String?   @unique @map("linkedin_url")
  industryTags     String[]  @map("industry_tags")
  sizeBand         String?   @map("size_band") // '1-10'|'11-50'|'51-200'|'201-500'|'500+'
  hqCity           String?   @map("hq_city")
  hqState          String?   @map("hq_state")
  lastResearchedAt DateTime? @map("last_researched_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  jobs            Job[]
  sources         Source[]
  moments         Moment[]
  contacts        Contact[]
  outreachBatches OutreachBatch[]

  @@index([domain])
  @@index([linkedinUrl])
  @@index([industryTags], map: "idx_companies_industry_tags", type: Gin)
  @@index([name])
  @@index([sizeBand])
  @@map("companies")
}

model Job {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String    @map("company_id") @db.Uuid
  title          String
  description    String?   @db.Text // Job description
  function       String // 'engineering'|'product'|'design'|'marketing'|'sales'|'operations'|'finance'|'other'
  majorTags      String[]  @map("major_tags")
  location       String?
  remoteFlag     Boolean   @default(false) @map("remote_flag")
  paidFlag       Boolean   @default(true) @map("paid_flag")
  payInfo        Json?     @map("pay_info")
  internshipType String?   @map("internship_type") // 'summer'|'semester'|'co-op'|'year-round'|'other'
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  sourceName     String    @map("source_name")
  sourceUrl      String    @unique @map("source_url")
  atsType        String    @map("ats_type") // 'greenhouse'|'lever'|'workday'|'other'|'manual'
  postedAt       DateTime? @map("posted_at") @db.Date
  lastVerifiedAt DateTime? @map("last_verified_at") @db.Date
  status         String    @default("active") // 'active'|'expired'|'closed'|'draft'
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  outreachBatches OutreachBatch[]

  @@index([companyId])
  @@index([majorTags], map: "idx_jobs_major_tags", type: Gin)
  @@index([location])
  @@index([function])
  @@index([status])
  @@index([postedAt])
  @@index([sourceUrl])
  @@index([remoteFlag])
  @@index([paidFlag])
  @@index([internshipType])
  @@index([atsType])
  @@map("jobs")
}

model Source {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String    @map("company_id") @db.Uuid
  type           String // 'site_page'|'podcast'|'video'|'press'|'award'|'blog'
  url            String    @unique
  title          String?
  publishedAt    DateTime? @map("published_at")
  transcriptText String?   @map("transcript_text")
  fetchedAt      DateTime  @default(now()) @map("fetched_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  moments Moment[]

  @@index([companyId])
  @@index([type])
  @@index([url])
  @@index([publishedAt])
  @@index([fetchedAt])
  @@map("sources")
}

model Moment {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId      String   @map("company_id") @db.Uuid
  sourceId       String   @map("source_id") @db.Uuid
  timestampStart String?  @map("timestamp_start") // "HH:MM:SS"
  timestampEnd   String?  @map("timestamp_end") // "HH:MM:SS"
  quote          String
  label          String // 'pain'|'plan'|'metric'|'hiring'|'mission'
  confidence     Decimal  @db.Decimal(3, 2)
  summary        String?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  source  Source  @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([sourceId])
  @@index([label])
  @@index([confidence])
  @@index([createdAt])
  @@map("moments")
}

model Contact {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId String @map("company_id") @db.Uuid

  // Basic info
  fullName   String  @map("full_name")
  firstName  String? @map("first_name")
  lastName   String? @map("last_name")
  title      String
  department String? @map("department")
  seniority  String? // 'Entry'|'Mid'|'Senior'|'Executive'|etc.

  // Contact details
  email           String?
  emailStatus     String?  @map("email_status") // 'valid'|'invalid'|'unknown'|'risky'
  emailConfidence Decimal? @map("email_confidence") @db.Decimal(5, 4)
  phoneNumber     String?  @map("phone_number")

  // Social profiles
  linkedinUrl     String? @map("linkedin_url")
  twitterHandle   String? @map("twitter_handle")
  githubUsername  String? @map("github_username")
  personalWebsite String? @map("personal_website")

  // Research data
  photoUrl        String? @map("photo_url")
  headline        String? // LinkedIn headline
  location        String?
  bio             String? @db.Text
  researchSummary String? @map("research_summary") @db.Text // AI-generated summary
  researchData    Json?   @map("research_data") // Raw research data

  // Metadata
  source     String? // 'apollo'|'linkedin'|'manual'|etc.
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  batchId        String?         @map("batch_id") @db.Uuid
  batch          OutreachBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)
  outreachEmails OutreachEmail[]

  @@unique([email, companyId], name: "unique_contact_per_company")
  @@index([companyId])
  @@index([batchId])
  @@index([email])
  @@index([linkedinUrl])
  @@index([department])
  @@index([emailConfidence])
  @@index([verifiedAt])
  @@map("contacts")
}

model User {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkId   String    @unique @map("clerk_id")
  email     String    @unique
  firstName String?   @map("first_name")
  lastName  String?   @map("last_name")
  school    String?
  major     String?
  gradDate  DateTime? @map("grad_date") @db.Date
  resumeUrl String?   @map("resume_url")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  outreachBatches OutreachBatch[]

  @@index([clerkId])
  @@index([email])
  @@index([school])
  @@index([major])
  @@index([gradDate])
  @@index([isActive])
  @@map("users")
}

model OutreachBatch {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String? @map("user_id") @db.Uuid
  jobId     String  @map("job_id") @db.Uuid
  companyId String  @map("company_id") @db.Uuid

  // Status tracking
  status      String  @default("pending") // 'pending'|'finding_contacts'|'researching'|'drafting_emails'|'completed'|'failed'
  currentStep String? @map("current_step") // Human-readable current step
  progress    Int     @default(0) // 0-100

  // Results summary
  totalContactsFound    Int @default(0) @map("total_contacts_found")
  totalContactsEnriched Int @default(0) @map("total_contacts_enriched")
  totalEmailsDrafted    Int @default(0) @map("total_emails_drafted")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Error handling
  errorMessage String? @map("error_message")
  errorStep    String? @map("error_step")
  retryCount   Int     @default(0) @map("retry_count")

  // Relations
  user     User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  job      Job             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts Contact[]
  emails   OutreachEmail[]

  @@index([userId])
  @@index([jobId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("outreach_batches")
}

model OutreachEmail {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contactId String  @map("contact_id") @db.Uuid
  batchId   String? @map("batch_id") @db.Uuid

  // Email content
  subject  String
  body     String  @db.Text
  bodyHtml String? @map("body_html") @db.Text

  // Personalization
  personalizations Json? // Variables used: {firstName, companyName, specificMention, etc}
  aiGeneratedBy    String? @map("ai_generated_by") // Model used: claude-3-5-sonnet, gpt-4, etc.
  generationPrompt String? @map("generation_prompt") @db.Text

  // Status
  status       String @default("draft") // 'draft'|'scheduled'|'sent'|'bounced'|'opened'|'replied'
  draftVersion Int    @default(1) @map("draft_version")

  // Engagement tracking (for future)
  sentAt    DateTime? @map("sent_at")
  openedAt  DateTime? @map("opened_at")
  clickedAt DateTime? @map("clicked_at")
  repliedAt DateTime? @map("replied_at")
  bouncedAt DateTime? @map("bounced_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contact Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
  batch   OutreachBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@index([batchId])
  @@index([status])
  @@index([sentAt])
  @@index([repliedAt])
  @@map("outreach_emails")
}
